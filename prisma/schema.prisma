// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String?  // Optional for OAuth users
  name      String?
  image     String?  // Profile picture from OAuth
  googleId  String?  @unique // Google OAuth ID
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  googleIntegration GoogleIntegration?
  driveSources      DriveSource[]
  driveFiles        DriveFile[]
  calendarEvents    CalendarEvent[]
}

model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?  @db.Text // Category playbook definition
  color       String?
  isFixed     Boolean  @default(false) // True for the 8 predefined categories
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  calls               Call[]   @relation("CallCategory")
  predictedCalls      Call[]   @relation("CallPredictedCategory")
  finalCategoryCalls  Call[]   @relation("CallCategoryFinal")
  prompts             Prompt[]
}

model Prompt {
  id                String    @id @default(cuid())
  name              String
  content           String    @db.Text  // Legacy field, kept for backwards compatibility
  analysisPrompt    String    @db.Text  // Prompt for analyzing call content
  ratingPrompt      String    @db.Text  // Prompt for rating criteria
  isActive          Boolean   @default(true)
  categoryId        String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  category          Category? @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  @@index([categoryId])
  @@index([isActive])
}

model Call {
  id                  String   @id @default(cuid())
  callTitle           String
  callDate            DateTime
  organizer           String
  participants        String[] @default([])
  transcript          String   @db.Text
  transcriptSummary   String?  @db.Text // Condensed 400-800 word summary for AI classification
  categoryId          String?
  aiAnalysis          String?  @db.Text
  aiRating            Float?
  aiSentiment         String?
  aiStrengths         String[] @default([])
  aiAreasForImprovement String[] @default([])
  driveFileId         String?  @unique
  
  // AI Category Prediction fields
  predictedCategoryId String?  // AI's category prediction
  confidenceScore     Float?   // 0.0 to 1.0
  categoryReasoning   String?  @db.Text // AI's reasoning bullets
  topCandidates       Json?    // Top 3 candidate categories with scores
  needsReview         Boolean  @default(false) // True if confidence 0.50-0.75
  
  // Human Override tracking
  categoryFinalId     String?  // User's final category choice (if overridden)
  wasOverridden       Boolean  @default(false)
  overriddenAt        DateTime?
  overriddenBy        String?  // User ID who overridden
  
  // External classification fields
  isExternal          Boolean?  // null = unknown, true = external, false = internal
  externalDomains     String[]  @default([]) // list of non-internal domains found
  calendarEventId     String?   // Google Calendar event ID
  classificationSource String?  // "calendar", "manual", "unknown"
  
  // Duplicate detection fields
  meetCode            String?   // Google Meet code for deduplication
  isDuplicate         Boolean   @default(false) // True if this is a duplicate of another call
  primaryCallId       String?   // Reference to the first imported call for this meeting
  duplicateOfUserId   String?   // User who imported the primary call
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  category            Category? @relation("CallCategory", fields: [categoryId], references: [id], onDelete: SetNull)
  predictedCategory   Category? @relation("CallPredictedCategory", fields: [predictedCategoryId], references: [id], onDelete: SetNull)
  categoryFinal       Category? @relation("CallCategoryFinal", fields: [categoryFinalId], references: [id], onDelete: SetNull)
  driveFile           DriveFile? @relation(fields: [driveFileId], references: [id], onDelete: SetNull)
  
  @@index([callTitle])
  @@index([categoryId])
  @@index([organizer])
  @@index([callDate])
  @@index([driveFileId])
  @@index([isExternal])
  @@index([calendarEventId])
  @@index([meetCode])
  @@index([isDuplicate])
  @@index([predictedCategoryId])
  @@index([needsReview])
  @@index([wasOverridden])
}

model GoogleIntegration {
  id            String   @id @default(cuid())
  userId        String   @unique
  refreshToken  String   @db.Text  // Encrypted
  accessToken   String?  @db.Text
  tokenExpiry   DateTime?
  scopes        String[] @default([])
  googleEmail   String?  // Email of the Google account
  googleName    String?  // Name of the Google account owner
  connectedAt   DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model DriveSource {
  id         String   @id @default(cuid())
  userId     String
  folderId   String
  folderName String?
  lastSync   DateTime?
  status     String   @default("active") // active, paused, error
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, folderId])
  @@index([userId])
  @@index([folderId])
}

model DriveFile {
  id                String   @id @default(cuid())
  userId            String
  googleFileId      String   @unique
  name              String
  mimeType          String
  modifiedTime      DateTime
  size              BigInt?
  md5Checksum       String?
  webViewLink       String?
  rawText           String?  @db.Text
  importedAt        DateTime?
  status            String   @default("pending") // pending, imported, error, skipped
  errorMessage      String?  @db.Text
  metadata          Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  calls             Call[]
  
  @@index([userId])
  @@index([googleFileId])
  @@index([status])
  @@index([modifiedTime])
}

model CalendarEvent {
  id                  String   @id @default(cuid())
  userId              String
  googleEventId       String   // Google Calendar event ID
  summary             String?
  description         String?  @db.Text
  startTime           DateTime
  endTime             DateTime
  organizer           String?  // Organizer email
  attendees           String[] @default([]) // Attendee emails
  attendeesOmitted    Boolean  @default(false)
  hangoutLink         String?
  meetCode            String?  // Google Meet code
  
  // Classification
  isExternal          Boolean?
  externalDomains     String[] @default([])
  
  // Import status
  hasTranscript       Boolean  @default(false)
  transcriptFileId    String?  // Link to DriveFile if found
  imported            Boolean  @default(false)
  importedCallId      String?  // Link to Call if imported
  
  // Duplicate detection
  isDuplicate         Boolean  @default(false) // True if another user already synced this meeting
  primaryEventId      String?  // Reference to the first synced event for this meeting
  primaryUserId       String?  // User who synced the primary event
  
  // Sync metadata
  syncedAt            DateTime @default(now())
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, googleEventId])
  @@index([userId])
  @@index([startTime])
  @@index([isExternal])
  @@index([imported])
  @@index([hasTranscript])
  @@index([meetCode])
  @@index([isDuplicate])
}

